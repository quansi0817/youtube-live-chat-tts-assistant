<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 直播聊天</title>
    <link rel="stylesheet" href="../css/youtube-chat.css">
</head>
<body>
    <div class="chat-container">
        <div id="messages" class="chat-messages">
            <div class="empty-state">等待聊天消息...</div>
        </div>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const messageIds = new Set(); // 防止重复消息

        /**
         * 添加消息到聊天窗口
         */
        function addMessage(data) {
            if (!data || !data.id) return;

            // 防止重复消息
            if (messageIds.has(data.id)) return;
            messageIds.add(data.id);

            // 清除空状态提示
            const emptyState = messagesEl.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // 根据消息类型创建不同的元素
            let msgEl;

            if (data.isSuperChat) {
                // Super Chat (付费消息)
                msgEl = createSuperChatMessage(data);
            } else if (data.isSuperSticker) {
                // Super Sticker (付费贴纸)
                msgEl = createSuperStickerMessage(data);
            } else if (data.isMembership) {
                // 会员消息
                msgEl = createMembershipMessage(data);
            } else {
                // 普通消息
                msgEl = createTextMessage(data);
            }

            // 添加点击TTS功能
            msgEl.addEventListener('click', () => {
                msgEl.classList.add('clicked');
                speakMessage(data);
            });

            // 添加新消息动画
            msgEl.classList.add('new');
            setTimeout(() => msgEl.classList.remove('new'), 300);

            // 添加到聊天窗口
            messagesEl.appendChild(msgEl);

            // 自动滚动到底部
            messagesEl.scrollTop = messagesEl.scrollHeight;

            // 限制消息数量（保留最新500条）
            const allMessages = messagesEl.children;
            if (allMessages.length > 500) {
                allMessages[0].remove();
                // 从Set中移除旧消息ID
                const firstId = allMessages[0].dataset.messageId;
                if (firstId) messageIds.delete(firstId);
            }
        }

        /**
         * 创建普通文本消息
         */
        function createTextMessage(data) {
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';
            msgEl.dataset.messageId = data.id;

            let html = '<div class="message-header">';

            // 添加头像
            if (data.authorPhoto) {
                html += `<img src="${data.authorPhoto}" class="author-photo" alt="${escapeHtml(data.author)}">`;
            }

            // 添加作者名
            html += `<span class="author-name">${escapeHtml(data.author)}</span>`;
            html += '</div>';

            // 添加消息内容（保留HTML以显示表情）
            if (data.messageHtml) {
                html += `<div class="message-content">${sanitizeHtml(data.messageHtml)}</div>`;
            } else {
                html += `<div class="message-content">${escapeHtml(data.message || '')}</div>`;
            }

            // 添加时间戳
            if (data.timestamp) {
                html += `<span class="timestamp">${escapeHtml(data.timestamp)}</span>`;
            }

            msgEl.innerHTML = html;
            return msgEl;
        }

        /**
         * 创建Super Chat消息
         */
        function createSuperChatMessage(data) {
            const msgEl = document.createElement('div');
            msgEl.className = 'super-chat';
            msgEl.dataset.messageId = data.id;

            // 根据金额确定等级（简单分类）
            const tier = getSuperChatTier(data.purchaseAmount);
            msgEl.classList.add(`tier-${tier}`);

            // 自定义背景颜色
            if (data.backgroundColor) {
                msgEl.style.background = data.backgroundColor;
            }

            let html = '<div class="super-chat-header">';
            html += '<div class="super-chat-author">';

            // 添加头像
            if (data.authorPhoto) {
                html += `<img src="${data.authorPhoto}" class="author-photo" alt="${escapeHtml(data.author)}">`;
            }

            // 添加作者名
            html += `<span class="author-name">${escapeHtml(data.author)}</span>`;
            html += '</div>';

            // 添加金额
            if (data.purchaseAmount) {
                html += `<span class="super-chat-amount">${escapeHtml(data.purchaseAmount)}</span>`;
            }

            html += '</div>';

            // 添加消息内容
            if (data.messageHtml) {
                html += `<div class="super-chat-message">${sanitizeHtml(data.messageHtml)}</div>`;
            } else if (data.message) {
                html += `<div class="super-chat-message">${escapeHtml(data.message)}</div>`;
            }

            msgEl.innerHTML = html;
            return msgEl;
        }

        /**
         * 创建Super Sticker消息
         */
        function createSuperStickerMessage(data) {
            const msgEl = document.createElement('div');
            msgEl.className = 'super-sticker';
            msgEl.dataset.messageId = data.id;

            let html = '<div class="super-chat-author">';

            // 添加头像和作者名
            if (data.authorPhoto) {
                html += `<img src="${data.authorPhoto}" class="author-photo" alt="${escapeHtml(data.author)}">`;
            }
            html += `<span class="author-name">${escapeHtml(data.author)}</span>`;
            html += '</div>';

            // 添加贴纸图片
            if (data.stickerUrl) {
                html += `<img src="${data.stickerUrl}" class="super-sticker-img" alt="Super Sticker">`;
            }

            // 添加金额
            if (data.purchaseAmount) {
                html += `<div class="super-sticker-amount">${escapeHtml(data.purchaseAmount)}</div>`;
            }

            msgEl.innerHTML = html;
            return msgEl;
        }

        /**
         * 创建会员消息
         */
        function createMembershipMessage(data) {
            const msgEl = document.createElement('div');
            msgEl.className = 'membership-message';
            msgEl.dataset.messageId = data.id;

            let html = '';

            // 添加头部信息
            if (data.headerPrimary) {
                html += `<div class="membership-header">${escapeHtml(data.headerPrimary)}</div>`;
            }

            if (data.headerSub) {
                html += `<div class="membership-subtext">${escapeHtml(data.headerSub)}</div>`;
            }

            // 添加消息内容
            if (data.messageHtml) {
                html += `<div class="membership-message-content">${sanitizeHtml(data.messageHtml)}</div>`;
            } else if (data.message) {
                html += `<div class="membership-message-content">${escapeHtml(data.message)}</div>`;
            }

            msgEl.innerHTML = html;
            return msgEl;
        }

        /**
         * 根据金额获取Super Chat等级
         */
        function getSuperChatTier(amount) {
            if (!amount) return 1;

            // 提取数字
            const numMatch = amount.match(/[\d,.]+/);
            if (!numMatch) return 1;

            const num = parseFloat(numMatch[0].replace(/,/g, ''));

            // 简单分类（可根据实际需要调整）
            if (num >= 500) return 7;
            if (num >= 200) return 6;
            if (num >= 100) return 5;
            if (num >= 50) return 4;
            if (num >= 20) return 3;
            if (num >= 5) return 2;
            return 1;
        }

        /**
         * 转义HTML（防止XSS）
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * 清理HTML，只保留安全的标签（表情图片等）
         */
        function sanitizeHtml(html) {
            if (!html) return '';

            const div = document.createElement('div');
            div.innerHTML = html;

            // 只保留img、yt-emoji等安全标签
            const allowedTags = ['IMG', 'YT-EMOJI', 'YT-FORMATTED-STRING', 'SPAN', 'A'];
            const elements = div.querySelectorAll('*');

            elements.forEach(el => {
                if (!allowedTags.includes(el.tagName)) {
                    // 不安全的标签，只保留文本内容
                    el.replaceWith(document.createTextNode(el.textContent));
                } else if (el.tagName === 'IMG') {
                    // 确保图片有正确的class
                    el.classList.add('emoji');
                    // 移除不安全的事件属性
                    Array.from(el.attributes).forEach(attr => {
                        if (attr.name.startsWith('on')) {
                            el.removeAttribute(attr.name);
                        }
                    });
                } else if (el.tagName === 'A') {
                    // 链接在新窗口打开
                    el.setAttribute('target', '_blank');
                    el.setAttribute('rel', 'noopener noreferrer');
                }
            });

            return div.innerHTML;
        }

        /**
         * TTS语音播放
         */
        function speakMessage(data) {
            if (!window.speechSynthesis) return;

            let text = '';

            if (data.isSuperChat) {
                text = `${data.author} 送出了 ${data.purchaseAmount} 的Super Chat`;
                if (data.message) {
                    text += `，说：${data.message}`;
                }
            } else if (data.isSuperSticker) {
                text = `${data.author} 送出了 ${data.purchaseAmount} 的Super Sticker`;
            } else if (data.isMembership) {
                text = `${data.author} ${data.headerPrimary}`;
                if (data.message) {
                    text += `，${data.message}`;
                }
            } else {
                text = `${data.author} 说：${data.message}`;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = 1.0;
            utterance.rate = 1.0;
            utterance.lang = 'zh-CN';
            window.speechSynthesis.speak(utterance);
        }

        // ==================== 消息接收监听器 ====================

        // 监听1: Custom Event
        window.addEventListener('youtubeChatMessage', (event) => {
            if (event.detail) {
                addMessage(event.detail);
            }
        });

        // 监听2: LocalStorage
        let lastLocalStorageCheck = 0;
        setInterval(() => {
            try {
                const stored = localStorage.getItem('youtubeChatMessage');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data && data.data && data.timestamp > lastLocalStorageCheck) {
                        lastLocalStorageCheck = data.timestamp;
                        addMessage(data.data);
                    }
                }
            } catch (e) {
                // Ignore
            }
        }, 300);

        // 监听3: PostMessage
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'YOUTUBE_CHAT_MESSAGE') {
                addMessage(event.data.data);
            }
        });

        // 监听4: Chrome Storage (Extension)
        if (typeof chrome !== 'undefined' && chrome.storage) {
            let lastChromeStorageTime = 0;

            setInterval(() => {
                chrome.storage.local.get(['lastChatMessage'], (result) => {
                    if (result.lastChatMessage && result.lastChatMessage.timestamp > lastChromeStorageTime) {
                        lastChromeStorageTime = result.lastChatMessage.timestamp;
                        if (result.lastChatMessage.type === 'YOUTUBE_CHAT_MESSAGE') {
                            addMessage(result.lastChatMessage.data);
                        }
                    }
                });
            }, 300);

            chrome.storage.onChanged.addListener((changes) => {
                if (changes.lastChatMessage) {
                    const newValue = changes.lastChatMessage.newValue;
                    if (newValue && newValue.type === 'YOUTUBE_CHAT_MESSAGE') {
                        addMessage(newValue.data);
                    }
                }
            });
        }

        // 监听5: BroadcastChannel
        try {
            const channel = new BroadcastChannel('youtube-chat-tts');
            channel.onmessage = (event) => {
                if (event.data && event.data.type === 'YOUTUBE_CHAT_MESSAGE') {
                    addMessage(event.data.data);
                }
            };
        } catch (e) {
            // BroadcastChannel not supported
        }

        // Debug: 日志输出
        console.log('YouTube Chat Display 已加载');
        console.log('等待接收聊天消息...');
    </script>
</body>
</html>
