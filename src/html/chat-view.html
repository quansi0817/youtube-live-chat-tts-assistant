<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat View - OBS Overlay</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent; 
            font-family: 'Noto Sans SC', sans-serif;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
        }

        #chat-messages {
            display: flex;
            flex-direction: column;
            gap: 2px; /* Very compact */
            overflow-y: auto;
            max-height: 100%;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }

        #chat-messages::-webkit-scrollbar {
            display: none;
        }

        .message-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            animation: fadeIn 0.2s ease-out;
            flex-shrink: 0;
            padding: 1px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message-body {
            min-width: 0;
            flex: 1;
            line-height: 1.4;
        }

        /* Generic Text Shadow for readability */
        .text-glow {
            color: #ffffff;
            text-shadow: 
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 0px 1px 2px rgba(0,0,0,0.8);
        }

        .message-author {
            font-weight: 700; /* Bold but not extra thick */
            font-size: 14px;
            margin-right: 4px;
        }

        .message-content {
            font-weight: 400; /* Normal weight, not too thick */
            font-size: 15px;
            word-wrap: break-word;
            display: inline;
        }

        .message-content img {
            height: 18px;
            vertical-align: middle;
            margin: 0 1px;
        }

        .message-item:hover {
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-messages"></div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const seenIds = new Set();
        let messageHistory = [];

        try {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                messageHistory = JSON.parse(saved);
                // Filter out empty messages before rendering - check both HTML and text
                messageHistory = messageHistory.filter(msg => {
                    if (!msg || !msg.author) return false;
                    const content = (msg.content || '').trim();
                    const textOnly = content.replace(/<[^>]*>/g, '').trim();
                    return content && content.length > 0 && textOnly && textOnly.length > 0;
                });
                // Update localStorage with cleaned history
                localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
                // Render cleaned messages
                messageHistory.forEach(msg => renderMessage(msg, false));
            }
        } catch (e) {}

        function renderMessage(data, save = true) {
            // Skip if no data, no author, duplicate, or empty content
            if (!data || !data.author || seenIds.has(data.id)) return;
            
            // Check if content is empty - strip HTML tags first
            let content = (data.content || '').trim();
            // Remove HTML tags to check if there's actual text
            const textOnly = content.replace(/<[^>]*>/g, '').trim();
            if (!content || content.length === 0 || !textOnly || textOnly.length === 0) {
                return; // Skip empty messages
            }
            
            seenIds.add(data.id);
            if (save) {
                messageHistory.push(data);
                if (messageHistory.length > 50) messageHistory.shift();
                localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
            }

            const item = document.createElement('div');
            item.className = 'message-item';
            item.onclick = () => {
                // Method 1: Store in chrome.storage
                if (window.chrome && chrome.storage) {
                    chrome.storage.local.set({ 'SELECTED_CHAT_MESSAGE': data });
                }
                
                // Method 2: Broadcast via BroadcastChannel for immediate update
                const selectedChannel = new BroadcastChannel('selected-message');
                selectedChannel.postMessage({
                    type: 'SELECTED_CHAT_MESSAGE',
                    data: data
                });
                selectedChannel.close();
            };

            item.innerHTML = `
                <img class="message-avatar" src="${data.authorPhoto || ''}" onerror="this.style.display='none'">
                <div class="message-body">
                    <span class="message-author text-glow">${data.author}:</span><span class="message-content text-glow">${data.content}</span>
                </div>
            `;

            chatMessages.appendChild(item);
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }

        window.addEventListener('youtubeChatMessage', (e) => {
            renderMessage(e.detail);
        });

        const settingsChannel = new BroadcastChannel('chat-settings');
        settingsChannel.onmessage = (e) => {
            if (e.data.type === 'UPDATE_BG_COLOR') {
                document.body.style.backgroundColor = e.data.color;
            }
        };

        const savedColor = localStorage.getItem('chatBgColor');
        if (savedColor) document.body.style.backgroundColor = savedColor;
    </script>
</body>
</html>
