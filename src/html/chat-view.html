<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat View - OBS Overlay</title>
    <style>
        /* Transparent background for OBS */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
        }

        #chat-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: 100%;
            /* Hide scrollbar */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }

        #chat-messages::-webkit-scrollbar {
            display: none;
        }

        .message-item {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
            flex-shrink: 0;
            padding: 2px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Top row: Avatar + Name + Time */
        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
            object-fit: cover;
        }

        .message-author {
            font-weight: 800;
            color: #ffffff;
            font-size: 14px;
            white-space: nowrap;
            /* Strong outline for readability */
            text-shadow: 
                -1.5px -1.5px 0 #000,  
                 1.5px -1.5px 0 #000,
                -1.5px  1.5px 0 #000,
                 1.5px  1.5px 0 #000,
                 0px 2px 4px rgba(0,0,0,1);
        }

        .message-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-left: auto;
            white-space: nowrap;
            text-shadow: 
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 0px 1px 3px rgba(0,0,0,1);
        }

        /* Bottom row: Message Content */
        .message-content {
            font-size: 16px;
            color: #ffffff;
            line-height: 1.3;
            word-wrap: break-word;
            word-break: break-all;
            padding-left: 2px;
            font-weight: 600;
            /* Standard high-visibility outline */
            text-shadow: 
                -1.5px -1.5px 0 #000,  
                 1.5px -1.5px 0 #000,
                -1.5px  1.5px 0 #000,
                 1.5px  1.5px 0 #000,
                 0px 2px 4px rgba(0,0,0,1);
        }

        .message-content img {
            height: 18px;
            vertical-align: middle;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-messages"></div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const seenIds = new Set();
        let messageHistory = [];

        // Load history from localStorage
        try {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                messageHistory = JSON.parse(saved);
                messageHistory.forEach(msg => renderMessage(msg, false));
            }
        } catch (e) {}

        function renderMessage(data, save = true) {
            if (!data || !data.author || seenIds.has(data.id)) return;
            
            seenIds.add(data.id);
            if (save) {
                messageHistory.push(data);
                if (messageHistory.length > 50) messageHistory.shift();
                localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
            }

            const item = document.createElement('div');
            item.className = 'message-item';
            item.onclick = () => {
                // Send to selected-view via chrome.storage
                if (window.chrome && chrome.storage) {
                    chrome.storage.local.set({ 'SELECTED_CHAT_MESSAGE': data });
                }
            };

            item.innerHTML = `
                <div class="message-header">
                    <img class="message-avatar" src="${data.authorPhoto || ''}" onerror="this.style.display='none'">
                    <span class="message-author">${data.author}</span>
                    <span class="message-time">${data.timestamp}</span>
                </div>
                <div class="message-content">${data.content}</div>
            `;

            chatMessages.appendChild(item);
            
            // Auto-scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }

        // Listen for messages from the extension
        window.addEventListener('youtubeChatMessage', (e) => {
            renderMessage(e.detail);
        });

        // Background color control via BroadcastChannel
        const settingsChannel = new BroadcastChannel('chat-settings');
        settingsChannel.onmessage = (e) => {
            if (e.data.type === 'UPDATE_BG_COLOR') {
                document.body.style.backgroundColor = e.data.color;
            }
        };

        // Initialize background color
        const savedColor = localStorage.getItem('chatBgColor');
        if (savedColor) document.body.style.backgroundColor = savedColor;
    </script>
</body>
</html>
